<link rel='stylesheet' href='/style/tree.css'/>

<div class="col-sm-4">
    <div class="panel panel-default">
        <div class="panel-heading">我的项目<a href="javascript:void(0);" data-toggle="modal"
                                          class="new-project" style="float: right">新项目</a>
        </div>
        <div class="panel-body">
            <div class="tree well" id="project-tree">
                <ul>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="col-sm-8" style="height: 600px">
    <iframe src="" class="embed-responsive-item" style="width: 100%;height: 100%" id="request-iframe">

    </iframe>
</div>


<!-- New Project Modal -->
<div class="modal fade" id="new-project-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新项目</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal new-project-form">
                    <div class="form-group">
                        <label for="name" class="col-sm-2 control-label">项目名称</label>
                        <div class="col-sm-6">
                            <input type="email" class="form-control" name="name" id="name" placeholder="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description" class="col-sm-2 control-label">描述</label>
                        <div class="col-sm-6">
                            <textarea name="description" class="form-control" id="description" rows="5"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save-new-project">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- New Request Modal -->
<div class="modal fade" id="new-request-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新请求</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal new-request-form">
                    <input name="projectId" type="hidden" id="projectId"/>
                    <div class="form-group">
                        <label for="request-name" class="col-sm-2 control-label">名称</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="name" id="request-name" placeholder="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="request-description" class="col-sm-2 control-label">描述</label>
                        <div class="col-sm-6">
                            <textarea name="description" class="form-control" id="request-description"
                                      rows="5"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save-new-request">确定</button>
            </div>
        </div>
    </div>
</div>

<script type="text/plain" class="project-template">
 \{{#each projects}}
    <li>
        <div class="parent" data-project-id="\{{id}}">
            <span class="project-node span-node" ><i class="icon-folder-open"></i>\{{name}} </span>
            <a href="javascript:void(0);" style="float: right" class="new-request">增加请求</a>
        </div>
        <ul class="requests">
        </ul>
    </li>
\{{/each}}



</script>

<script type="text/plain" class="request-template">
 \{{#each requests}}
    <li data-id="\{{id}}">
        <span class="rquest-span"><i class="icon-leaf"></i>\{{name}}</span>
    </li>
\{{/each}}




</script>

<script type="application/javascript">
    $(function () {
        var projectTemplate = Handlebars.compile($(".project-template").text());
        var requestemplate = Handlebars.compile($(".request-template").text());

        $(".new-project").click(function () {
            $('#new-project-modal form')[0].reset();
            $('#new-project-modal').modal('show')
        });

        $("#save-new-project").click(function () {
            $.post("/projects", $(".new-project-form").serialize()).then(function (data) {
                if (messagePro(data)) {
                    $("#project-tree ul:first").append(projectTemplate({projects: [data.data]}));
                    $('#new-project-modal').modal('hide')
                }
            });
        });

        $("#save-new-request").click(function () {
            $.post("/requests", $(".new-request-form").serialize()).then(function (data) {
                if (messagePro(data)) {
                    $('#new-request-modal').data("parent").closest("li").find(".requests")
                            .append(requestemplate({requests: [data.data]}));
                    $('#new-request-modal').modal('hide')
                }
            });
        });

        function initTree() {
            $('.tree li:has(ul)').addClass('parent_li').find('span').attr('title', '扩展');
        }

        $("body").on('click', ".new-request", function () {
            var modal = $("#new-request-modal");
            modal.find("form")[0].reset();
            $parent = $(this).closest(".parent");
            modal.find("#projectId").val($parent.data("project-id"));
            $('#new-request-modal').data("parent", $parent);
            $("#new-request-modal").modal("show");
        });

        $("body").on('click', ".project-node", function (e) {
            var $this = $(this);
            if (!$this.data("had-load")) {
                $this.data("had-load", true);
                $.getJSON("/requests?projectId=" + $this.closest(".parent").data("project-id")).then(function (data) {
                    if (messagePro(data)) {

                        $this.closest(".parent").closest("li").find(".requests").append(requestemplate({requests: data.data}));
                    } else {
                        $this.data("had-load", false);
                    }
                });
            } else {
                var children = $this.closest('li.parent_li').find(' > ul > li');
                if (children.is(":visible")) {
                    children.hide('fast');
                    $(this).attr('title', 'Expand this branch').find(' > i').addClass('icon-plus-sign').removeClass('icon-minus-sign');
                } else {
                    children.show('fast');
                    $(this).attr('title', 'Collapse this branch').find(' > i').addClass('icon-minus-sign').removeClass('icon-plus-sign');
                }
            }
            e.stopPropagation();
        });

        $("body").on("click", ".rquest-span", function () {
            var requestId = $(this).closest("li").data("id");
            $("#request-iframe").attr("src", "/requests/" + requestId);
        });

        //load projects
        $.getJSON("/projects").then(function (data) {
            if (messagePro(data)) {
                $("#project-tree ul").html(projectTemplate({projects: data.data}));
                initTree();
            }
        });

    });
</script>
<script src="/js/tree.js"></script>